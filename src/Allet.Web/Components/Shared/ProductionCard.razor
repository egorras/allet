@using Allet.Web.Models

<div class="col-md-4 col-lg-3 mb-4 production-item">
    <div class="card h-100 @(IsArchived ? "border-warning" : "")">
        @if (!string.IsNullOrEmpty(Production.ImageUrl))
        {
            <img src="@Production.ImageUrl" class="card-img-top" alt="@Production.Title" style="height: 200px; object-fit: cover; @(IsArchived ? "opacity: 0.6;" : "")" />
        }
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">
                <a href="productions/@Production.Id" class="text-decoration-none">@Production.Title</a>
                @if (IsArchived)
                {
                    <span class="badge bg-secondary text-white ms-1">Archived</span>
                }
                @if (IsWatched)
                {
                    <span class="badge bg-success text-white ms-1">Watched</span>
                }
                @if (IsPlanned)
                {
                    <span class="badge bg-info text-dark ms-1">Planned</span>
                }
            </h5>
            
            @if (IsWatched && Activity?.WatchedDate.HasValue == true)
            {
                <div class="small text-success fw-bold">Watched on @Activity.WatchedDate.Value.ToString("d MMM yyyy")</div>
            }
            @if (IsPlanned && Activity?.Show != null && Activity.Show.Date.HasValue)
            {
                <div class="small text-info fw-bold">Planned for @Activity.Show.Date.Value.ToString("d MMM yyyy HH:mm")</div>
            }

            <p class="card-text text-muted mb-1">@Production.Season</p>
            @if (Venues.Count > 0)
            {
                <p class="card-text text-muted mb-1">@string.Join(", ", Venues)</p>
            }
            @if (Dates.Count > 0)
            {
                <p class="card-text text-muted mb-1">
                    @if (Dates.First().Date == Dates.Last().Date)
                    {
                        @Dates.First().ToString("d MMM yyyy")
                    }
                    else
                    {
                        @($"{Dates.First():d MMM yyyy} â€“ {Dates.Last():d MMM yyyy}")
                    }
                </p>
            }
            @if (!string.IsNullOrEmpty(Production.Category))
            {
                <p class="card-text mb-1">
                    <span class="badge bg-primary">@Production.Category</span>
                </p>
            }
            @if (!string.IsNullOrEmpty(Production.Tags))
            {
                <p class="card-text mb-2">
                    @foreach (var tag in Production.Tags.Split(',', StringSplitOptions.TrimEntries))
                    {
                        <span class="badge bg-info text-dark me-1">@tag</span>
                    }
                </p>
            }
            <div class="mt-auto">
                <span class="badge bg-secondary mb-2">@Production.Shows.Count show(s)</span>
                <div class="d-flex justify-content-end gap-1 status-action">
                    <button class="btn btn-sm @(IsWatched ? "btn-success" : "btn-outline-success")" @onclick="() => RequestStatusChange(IsWatched ? ProductionUserStatus.None : ProductionUserStatus.Watched)" title="Mark as Watched">
                        <i class="bi bi-check-lg"></i>
                    </button>
                    <button class="btn btn-sm @(IsPlanned ? "btn-info" : "btn-outline-info")" @onclick="() => RequestStatusChange(IsPlanned ? ProductionUserStatus.None : ProductionUserStatus.Planned)" title="Mark as Planned">
                        <i class="bi bi-calendar-event"></i>
                    </button>
                    <button class="btn btn-sm @(IsArchived ? "btn-secondary" : "btn-outline-secondary")" @onclick="() => RequestStatusChange(IsArchived ? ProductionUserStatus.None : ProductionUserStatus.Archived)" title="Archive">
                        <i class="bi bi-archive"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .production-item .status-action {
        opacity: 0;
        transition: opacity 0.2s;
    }

    .production-item:hover .status-action {
        opacity: 1;
    }
</style>

@code {
    [Parameter, EditorRequired] public required Production Production { get; set; }
    [Parameter] public UserProductionActivity? Activity { get; set; }
    [Parameter] public EventCallback<ProductionUserStatus> OnStatusChange { get; set; }

    private List<DateTime> Dates => Production.Shows.Where(s => s.Date.HasValue).Select(s => s.Date!.Value).OrderBy(d => d).ToList();
    private List<string> Venues => Production.Shows.Where(s => s.Venue != null).Select(s => s.Venue!.Name).Distinct().ToList();

    private ProductionUserStatus UserStatus => Activity?.Status ?? ProductionUserStatus.None;
    private bool IsWatched => UserStatus == ProductionUserStatus.Watched;
    private bool IsPlanned => UserStatus == ProductionUserStatus.Planned;
    private bool IsArchived => UserStatus == ProductionUserStatus.Archived;

    private async Task RequestStatusChange(ProductionUserStatus status)
    {
        await OnStatusChange.InvokeAsync(status);
    }
}
